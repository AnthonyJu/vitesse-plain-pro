
#user  nobody;
worker_processes 1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;
events {
    worker_connections 1024;
}


http {
    include mime.types;
    default_type application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;
    access_log off;

    sendfile on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout 65;

    #gzip  on;

    # 全局设置（对所有 server 生效）
    client_max_body_size 10000m; 

    server {
        listen 80;
        server_name 127.0.0.1;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root html;
        }

        location / {
            # 禁止缓存（完全禁用存储）
            add_header Cache-Control "no-store, no-cache, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";

            root "../webs";
            index index.html index.htm;
                        
            add_header 'Cross-Origin-Embedder-Policy' 'require-corp';
            add_header 'Cross-Origin-Opener-Policy' 'same-origin';
            add_header 'Cross-Origin-Resource-Policy' 'cross-origin';
        }

        location ~ /ISAPI|SDK/ {
            # 保持设备的 Host 请求头
            proxy_set_header Host $host;
            # 保持设备的 Referer 请求头
            proxy_set_header Referer $http_referer;
            proxy_set_header Sec-Fetch-Site "";
            proxy_set_header Sec-Fetch-Mode "";
            proxy_set_header Sec-Fetch-Dest "";
            if ($http_cookie ~ "webVideoCtrlProxy=(.+)") {
                # Nginx 示例：删除 Sec-Fetch-* 字段
                proxy_pass http://$cookie_webVideoCtrlProxy;
                break;
            }
        }
        location ^~ /webSocketVideoCtrlProxy {
            #web socket
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            # 保持设备的 Host 请求头
            proxy_set_header Host $host;
            # 保持设备的 Referer 请求头
            proxy_set_header Referer $http_referer;
            if ($http_cookie ~ "webVideoCtrlProxyWs=(.+)") {
                proxy_pass http://$cookie_webVideoCtrlProxyWs/$cookie_webVideoCtrlProxyWsChannel?$args;
                break;
            }
            if ($http_cookie ~ "webVideoCtrlProxyWss=(.+)") {
                proxy_pass http://$cookie_webVideoCtrlProxyWss/$cookie_webVideoCtrlProxyWsChannel?$args;
                break;
            }
        }
    }

    # HTTPS server
    #
    server {
        listen 443 ssl;
        server_name www.lchlgd.com;

        ssl_certificate ../lee.crt;
        ssl_certificate_key ../lee.key;

        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout 5m;

        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;


        location / {
            # 禁止缓存（完全禁用存储）
            add_header Cache-Control "no-store, no-cache, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";

            root "../webs";
            index index.html index.htm;
            add_header 'Cross-Origin-Embedder-Policy' 'require-corp';
            add_header 'Cross-Origin-Opener-Policy' 'same-origin';
            add_header 'Cross-Origin-Resource-Policy' 'cross-origin';
        }

        location ~ /ISAPI|SDK/ {
            # 保持设备的 Host 请求头
            proxy_set_header Host $host;
            # 保持设备的 Referer 请求头
            proxy_set_header Referer $http_referer;
            proxy_set_header Sec-Fetch-Site "";
            proxy_set_header Sec-Fetch-Mode "";
            proxy_set_header Sec-Fetch-Dest "";
            if ($http_cookie ~ "webVideoCtrlProxy=(.+)") {
                # Nginx 示例：删除 Sec-Fetch-* 字段
                proxy_pass https://$cookie_webVideoCtrlProxy;
                break;
            }
            add_header 'Cross-Origin-Embedder-Policy' 'require-corp';
            add_header 'Cross-Origin-Opener-Policy' 'same-origin';
            add_header 'Cross-Origin-Resource-Policy' 'cross-origin';
        }
        location ^~ /webSocketVideoCtrlProxy {
            #web socket
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            # 保持设备的 Host 请求头
            proxy_set_header Host $host;
            # 保持设备的 Referer 请求头
            proxy_set_header Referer $http_referer;
            if ($http_cookie ~ "webVideoCtrlProxyWss=(.+)") {
                proxy_pass https://$cookie_webVideoCtrlProxyWss/?$args;
                break;
            }
            if ($http_cookie ~ "webVideoCtrlProxyWs=(.+)") {
                proxy_pass https://$cookie_webVideoCtrlProxyWs/?$args;
                break;
            }
            add_header 'Cross-Origin-Embedder-Policy' 'require-corp';
            add_header 'Cross-Origin-Opener-Policy' 'same-origin';
            add_header 'Cross-Origin-Resource-Policy' 'cross-origin';

        }
    }

}
